<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winget Pro - V35 Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg-main: #0f172a; --card-bg: #1e293b; --accent: #3b82f6; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: #f1f5f9; user-select: none; overflow: hidden; }
        
        .app-card { transition: all 0.2s; border: 1px solid #334155; background-color: var(--card-bg); }
        .app-card:hover { border-color: var(--accent); transform: translateY(-2px); background-color: #1f2937; }
        
        .app-checkbox:checked + .app-content { background: linear-gradient(145deg, #1e3a8a, #172554); border-color: var(--accent); }
        .app-checkbox:checked + .app-content .check-icon { opacity: 1; transform: scale(1); }
        .app-checkbox:checked + .app-content .app-id { color: #93c5fd; }

        .donate-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid #334155; transition: all 0.3s ease; }
        .donate-card:hover { border-color: #10b981; transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.3); }

        .loader { border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid #3b82f6; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s infinite linear; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        /* Menu Mobile */
        #mobileMenu { transition: transform 0.3s ease-in-out; }
        .menu-closed { transform: translateX(-100%); }
        .menu-open { transform: translateX(0); }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="flex h-screen relative">
        
        <!-- SIDEBAR (Desktop) -->
        <aside class="w-72 bg-slate-900 border-r border-slate-800 flex flex-col hidden md:flex z-20 shrink-0">
            <div class="p-6 border-b border-slate-800 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fa-brands fa-microsoft text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">Winget<span class="text-blue-500">Pro</span></h1>
                    <span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700">v1.0 Stable</span>
                </div>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto space-y-6">
                <nav class="space-y-2">
                    <button onclick="switchTab('home')" id="nav-home" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl bg-blue-600 text-white shadow-md transition-all text-left">
                        <i class="fa-solid fa-layer-group w-5 text-center"></i> Biblioteca
                    </button>
                    <button onclick="switchTab('about')" id="nav-about" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-400 hover:bg-slate-800 transition-all text-left">
                        <i class="fa-solid fa-circle-info w-5 text-center"></i> Sobre
                    </button>
                    <button onclick="switchTab('donate')" id="nav-donate" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-400 hover:bg-slate-800 hover:text-emerald-400 transition-all text-left group">
                        <i class="fa-solid fa-heart w-5 text-center group-hover:text-red-500 transition-colors"></i> Doar
                    </button>
                </nav>

                <div>
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase px-2 mb-2">Kits Rápidos</h3>
                    <div class="space-y-2">
                        <button onclick="applyPreset('basic')" class="w-full text-left px-4 py-2.5 rounded-lg text-sm text-slate-300 hover:bg-slate-800 border border-transparent hover:border-slate-700 transition flex items-center gap-3"><span class="w-2 h-2 rounded-full bg-green-500"></span> Essencial</button>
                        <button onclick="applyPreset('gamer')" class="w-full text-left px-4 py-2.5 rounded-lg text-sm text-slate-300 hover:bg-slate-800 border border-transparent hover:border-slate-700 transition flex items-center gap-3"><span class="w-2 h-2 rounded-full bg-purple-500"></span> Gamer</button>
                        <button onclick="applyPreset('dev')" class="w-full text-left px-4 py-2.5 rounded-lg text-sm text-slate-300 hover:bg-slate-800 border border-transparent hover:border-slate-700 transition flex items-center gap-3"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Dev Pack</button>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-800 bg-slate-900">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] text-slate-500 font-bold uppercase">Selecionados</span>
                    <span id="sidebarCount" class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">0</span>
                </div>
                <button onclick="downloadPackage()" id="sidebarDownloadBtn" disabled class="w-full bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-800 disabled:text-slate-600 text-white text-xs font-bold py-3 rounded-lg transition-all shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-zipper"></i> BAIXAR PACOTE
                </button>
            </div>
        </aside>

        <!-- MENU MOBILE (Overlay) -->
        <div id="mobileOverlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/80 z-40 hidden md:hidden backdrop-blur-sm"></div>
        <aside id="mobileMenu" class="fixed inset-y-0 left-0 w-72 bg-slate-900 z-50 flex flex-col md:hidden menu-closed shadow-2xl border-r border-slate-800">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <span class="font-bold text-white text-xl">Menu</span>
                <button onclick="toggleMobileMenu()" class="text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-4 flex-1 space-y-4">
                <button onclick="switchTab('home');toggleMobileMenu()" class="w-full text-left px-4 py-3 rounded-lg bg-slate-800 text-white">Biblioteca</button>
                <button onclick="switchTab('about');toggleMobileMenu()" class="w-full text-left px-4 py-3 rounded-lg bg-slate-800 text-white">Sobre</button>
                <button onclick="switchTab('donate');toggleMobileMenu()" class="w-full text-left px-4 py-3 rounded-lg bg-slate-800 text-emerald-400">Doar</button>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="flex-1 flex flex-col overflow-hidden relative bg-[#0b1120]">
            
            <!-- Barra de Busca / Header Mobile -->
            <div class="bg-slate-900/90 backdrop-blur border-b border-slate-800 p-4 z-30 flex gap-3 shadow-lg items-center justify-center">
                <button onclick="toggleMobileMenu()" class="md:hidden text-white p-2 bg-slate-800 rounded border border-slate-700"><i class="fa-solid fa-bars"></i></button>
                <div class="relative w-full max-w-2xl group">
                    <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-500 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" id="search" placeholder="Pesquisar na Nuvem..." class="w-full bg-slate-800 border border-slate-700 text-white rounded-xl py-3 pl-12 pr-24 outline-none focus:border-blue-500 transition-all" onkeydown="if(event.key==='Enter') searchOnline()">
                    <button onclick="searchOnline()" class="absolute right-2 top-2 bg-slate-700 hover:bg-blue-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-2 border border-slate-600">
                        <span id="btnSearchText">BUSCAR</span><div id="searchLoader" class="loader hidden"></div>
                    </button>
                </div>
            </div>

            <!-- Conteúdo -->
            <div class="flex-1 overflow-y-auto p-6 scroll-smooth" id="mainScroll">
                
                <!-- ABA HOME -->
                <div id="tab-home" class="fade-in max-w-7xl mx-auto pb-20">
                    <!-- Anúncio Topo -->
                    <div class="ad-space w-full h-[90px] mb-8 bg-slate-900/30 border border-dashed border-slate-800 rounded-xl flex items-center justify-center text-slate-600 text-xs uppercase"><span>Espaço Publicitário (Topo)</span></div>

                    <!-- Resumo da Fila -->
                    <div id="summaryArea" class="hidden mb-10 bg-slate-900 border border-slate-700 rounded-2xl p-5 shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider">Fila de Instalação</h3>
                            <div class="flex gap-3">
                                <button onclick="clearAll()" class="text-xs text-red-400 hover:underline">Limpar</button>
                                <!-- Botão de Download Mobile -->
                                <button onclick="downloadPackage()" id="mainDlBtn" class="md:hidden bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-2">
                                    <i class="fa-solid fa-download"></i> Baixar
                                </button>
                            </div>
                        </div>
                        <div id="summaryGrid" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Resultados Online -->
                    <div id="onlineResults" class="hidden mb-10">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-800 pb-2">
                            <h2 class="text-lg font-bold text-white">Resultados da Web</h2>
                            <button onclick="clearSearch()" class="text-xs text-slate-500 hover:text-white bg-slate-800 px-3 py-1 rounded">Fechar</button>
                        </div>
                        <div id="onlineGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                    </div>

                    <!-- Lista Fixa -->
                    <div id="fixedGrid"></div>
                    
                    <!-- Anúncio Rodapé -->
                    <div class="ad-space w-full h-[90px] mt-12 bg-slate-900/30 border border-dashed border-slate-800 rounded-xl flex items-center justify-center text-slate-600 text-xs uppercase"><span>Espaço Publicitário (Rodapé)</span></div>
                </div>

                <!-- ABA SOBRE -->
                <div id="tab-about" class="hidden fade-in max-w-3xl mx-auto pt-10">
                    <div class="bg-slate-900 border border-slate-700 rounded-2xl p-8 shadow-2xl">
                        <h2 class="text-2xl font-bold text-white mb-4">Sobre o Winget Pro</h2>
                        <p class="text-slate-400 mb-4">Ferramenta para criar pacotes de instalação automática.</p>
                        <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 text-sm text-slate-300">
                            <ol class="list-decimal pl-5 space-y-2">
                                <li>Selecione os apps.</li>
                                <li>Baixe o ZIP.</li>
                                <li>Extraia e execute o <b>Instalador.exe</b>.</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- ABA DOAÇÕES -->
                <div id="tab-donate" class="hidden fade-in max-w-4xl mx-auto pt-6">
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-bold text-white mb-2">Apoie o Projeto</h2>
                        <p class="text-slate-400">Ajude a manter a ferramenta gratuita.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                        <!-- PIX -->
                        <div class="donate-card rounded-2xl p-6 flex flex-col items-center text-center border border-slate-700 bg-slate-800">
                            <i class="fa-brands fa-pix text-3xl text-emerald-400 mb-3"></i>
                            <h3 class="text-xl font-bold text-white mb-2">Pix</h3>
                            <div class="bg-slate-900 p-3 rounded-lg border border-slate-700 w-full mb-4">
                                <code class="text-sm font-mono text-emerald-400 select-all">anderson.tavares.silva@gmail.com</code>
                            </div>
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=anderson.tavares.silva@gmail.com" class="w-32 h-32 rounded mb-2">
                        </div>

                        <!-- MERCADO PAGO -->
                        <div class="donate-card rounded-2xl p-6 flex flex-col items-center text-center border border-slate-700 bg-slate-800">
                            <i class="fa-solid fa-handshake text-3xl text-sky-400 mb-3"></i>
                            <h3 class="text-xl font-bold text-white mb-2">Mercado Pago</h3>
                            <p class="text-xs text-slate-400 mb-4">Cartão ou Saldo.</p>
                            
                            <!-- Link Corrigido com Block e Text-Center -->
                            <a href="https://link.mercadopago.com.br/anderson001" target="_blank" class="block w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg text-center mt-auto">
                                Pagar Agora <i class="fa-solid fa-arrow-right ml-2"></i>
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-slate-800 border-l-4 border-green-500 text-white px-6 py-4 rounded-lg shadow-2xl translate-y-32 opacity-0 transition-all duration-300 z-50 flex items-center gap-3"><i class="fa-solid fa-check-circle text-green-500 text-xl"></i><div><h4 class="font-bold text-sm">Adicionado</h4><p id="toastMsg" class="text-xs text-slate-400"></p></div></div>

    <script>
        const db = [
            { cat: "Navegadores", icon: "fa-brands fa-chrome", apps: [ {n:"Chrome",id:"Google.Chrome",i:"fa-brands fa-chrome text-red-500"}, {n:"Firefox",id:"Mozilla.Firefox",i:"fa-brands fa-firefox-browser text-orange-500"}, {n:"Edge",id:"Microsoft.Edge",i:"fa-brands fa-edge text-blue-500"}, {n:"Brave",id:"Brave.Brave",i:"fa-brands fa-fort-awesome text-orange-600"} ]},
            { cat: "Essenciais", icon: "fa-solid fa-box-archive", apps: [ {n:"WinRAR",id:"RARLab.WinRAR",i:"fa-solid fa-file-zipper text-purple-500"}, {n:"7-Zip",id:"7zip.7zip",i:"fa-solid fa-box-open"}, {n:"Visual C++",id:"Abbottsoftware.VcRedistAIO",i:"fa-brands fa-windows text-blue-400"}, {n:"DirectX",id:"Microsoft.DirectX",i:"fa-solid fa-gamepad text-green-500"}, {n:"Java",id:"Oracle.JavaRuntimeEnvironment",i:"fa-brands fa-java text-red-600"} ]},
            { cat: "Multimídia", icon: "fa-solid fa-play", apps: [ {n:"VLC",id:"VideoLAN.VLC",i:"fa-solid fa-circle-play text-orange-500"}, {n:"Spotify",id:"Spotify.Spotify",i:"fa-brands fa-spotify text-green-500"}, {n:"K-Lite",id:"CodecGuide.K-LiteCodecPack.Mega",i:"fa-solid fa-film text-gray-400"} ]},
            { cat: "Ferramentas", icon: "fa-solid fa-wrench", apps: [ {n:"AnyDesk",id:"AnyDeskSoftwareGmbH.AnyDesk",i:"fa-solid fa-desktop text-red-500"}, {n:"TeamViewer",id:"TeamViewer.TeamViewer",i:"fa-solid fa-arrow-right-arrow-left text-blue-500"}, {n:"Adobe Reader",id:"Adobe.Acrobat.Reader.64-bit",i:"fa-solid fa-file-pdf text-red-600"}, {n:"LibreOffice",id:"TheDocumentFoundation.LibreOffice",i:"fa-solid fa-file-word"}, {n:"CrystalDisk",id:"CrystalDewWorld.CrystalDiskInfo",i:"fa-solid fa-hard-drive text-blue-300"} ]}
        ];

        let queue = new Map();

        (function init() { renderFixed(); })();

        function toggleMobileMenu() {
            const m = document.getElementById('mobileMenu'); const o = document.getElementById('mobileOverlay');
            if(m.classList.contains('menu-closed')) { m.classList.remove('menu-closed'); m.classList.add('menu-open'); o.classList.remove('hidden'); }
            else { m.classList.add('menu-closed'); m.classList.remove('menu-open'); o.classList.add('hidden'); }
        }

        function switchTab(tabName) {
            document.getElementById('tab-home').classList.add('hidden');
            document.getElementById('tab-about').classList.add('hidden');
            document.getElementById('tab-donate').classList.add('hidden');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.getElementById('mainScroll').scrollTop = 0;
        }

        function renderFixed() {
            const c = document.getElementById('fixedGrid'); c.innerHTML = '';
            db.forEach(cat => {
                c.innerHTML += `<div class="mb-8"><div class="flex items-center gap-2 text-slate-400 border-b border-slate-800 pb-2 mb-4"><i class="${cat.icon}"></i><h3 class="font-bold text-xs tracking-widest uppercase text-slate-500">${cat.cat}</h3></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">${cat.apps.map(a => cardHtml(a.n, a.id, a.i)).join('')}</div></div>`;
            });
        }

        function cardHtml(n, id, i, online=false) {
            const chk = queue.has(id) ? 'checked' : '';
            const sn = n.replace(/'/g,""); const sid = id.replace(/'/g,""); const si = (i||"").replace(/'/g,"");
            const fn = `toggle(this, '${sn}','${sid}','${si}')`;
            let icon = si.startsWith('http') ? `<img src="${si}" class="w-6 h-6 object-contain">` : `<i class="${si||getIcon(n)} text-xl"></i>`;
            return `<label class="app-card relative block p-4 rounded-xl cursor-pointer h-full group"><input type="checkbox" class="app-checkbox hidden" value="${sid}" onchange="${fn}" ${chk}><div class="app-content p-4 rounded-xl flex items-center gap-4 h-full border border-transparent transition-all relative -m-4"><div class="w-12 h-12 bg-slate-900/80 rounded-lg flex items-center justify-center text-slate-400 shadow-inner ring-1 ring-white/5 group-hover:text-white transition-colors">${icon}</div><div class="min-w-0 flex-1"><div class="font-bold text-sm text-slate-200 truncate">${n}</div><div class="text-[10px] text-slate-500 truncate font-mono opacity-70">${id}</div></div><div class="check-indicator opacity-0 absolute top-3 right-3 text-blue-500 transition-all transform scale-50 bg-white rounded-full shadow-lg"><i class="fa-solid fa-circle-check text-lg"></i></div></div></label>`;
        }

        function getIcon(n) { return 'fa-solid fa-box-open'; }

        function toggle(cb, n, id, i) {
            if(!i || i==='undefined') i = getIcon(n);
            if(cb.checked) { queue.set(id, {n, id, i}); showToast(n); } else { queue.delete(id); }
            sync();
        }

        function sync() {
            document.querySelectorAll('.app-checkbox').forEach(c => c.checked = queue.has(c.value));
            const cnt = queue.size;
            document.getElementById('sidebarCount').innerText = cnt;
            const btn = document.getElementById('sidebarDownloadBtn');
            const mainBtn = document.getElementById('mainDlBtn');
            if(btn) btn.disabled = cnt===0;
            
            const g = document.getElementById('summaryGrid');
            const a = document.getElementById('summaryArea');
            if(a && g) {
                g.innerHTML = '';
                if(cnt === 0) { a.classList.add('hidden'); if(mainBtn) mainBtn.classList.add('hidden'); }
                else {
                    a.classList.remove('hidden');
                    if(mainBtn) mainBtn.classList.remove('hidden');
                    queue.forEach(v => {
                        let ico = v.i.startsWith('http') ? `<img src="${v.i}" class="w-4 h-4">` : `<i class="${v.i} text-xs"></i>`;
                        g.innerHTML += `<div class="bg-slate-800 border border-slate-700 px-3 py-2 rounded-lg flex items-center gap-2 cursor-pointer hover:border-red-500 transition-colors" onclick="queue.delete('${v.id}');sync();">${ico}<span class="text-xs text-slate-300 truncate max-w-[100px]">${v.n}</span><i class="fa-solid fa-xmark text-[10px] text-red-500 ml-auto"></i></div>`;
                    });
                }
            }
        }

        function clearAll() { queue.clear(); sync(); }
        
        function applyPreset(t) {
            const p = { 'basic':['Google.Chrome','RARLab.WinRAR'], 'gamer':['Valve.Steam','Discord.Discord'] };
            if(p[t]) p[t].forEach(id => { let n=id; let i=''; for(let c of db) { let f=c.apps.find(a=>a.id===id); if(f){n=f.n;i=f.i;break;} } queue.set(id,{n,id,i}); });
            sync(); showToast("Kit Aplicado");
        }

        async function searchOnline() {
            const q = document.getElementById('search').value.trim();
            if(q.length < 2) return;
            const g = document.getElementById('onlineGrid');
            const a = document.getElementById('onlineResults');
            document.getElementById('btnSearchText').classList.add('hidden');
            document.getElementById('searchLoader').classList.remove('hidden');
            g.innerHTML = ''; a.classList.remove('hidden');
            try {
                const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://api.winget.run/v2/packages?take=8&query='+q)}`);
                const d = await r.json();
                const j = JSON.parse(d.contents);
                if(j.Packages) {
                    j.Packages.forEach(p => {
                        let icon = null;
                        if(p.Versions[0].Homepage) try{icon=`https://www.google.com/s2/favicons?domain=${new URL(p.Versions[0].Homepage).hostname}&sz=64`}catch(e){}
                        g.innerHTML += cardHtml(p.Name, p.Id, icon, true);
                    });
                } else g.innerHTML = '<div class="col-span-full text-center text-slate-500 py-4">Sem resultados.</div>';
            } catch(e) { g.innerHTML = '<div class="col-span-full text-center text-red-400 py-4">Erro na busca.</div>'; }
            finally { document.getElementById('btnSearchText').classList.remove('hidden'); document.getElementById('searchLoader').classList.add('hidden'); }
        }

        function clearSearch() { document.getElementById('search').value = ''; document.getElementById('onlineResults').classList.add('hidden'); }
        function showToast(m) { const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = m; t.classList.remove('translate-y-32', 'opacity-0'); setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000); }

        async function downloadPackage() {
            if(queue.size === 0) return;
            const btn = document.getElementById('sidebarDownloadBtn');
            const loader = document.getElementById('dlLoader');
            const status = document.getElementById('dlStatus');
            if(btn) btn.disabled = true;
            if(loader) loader.classList.remove('hidden');
            if(status) status.classList.add('hidden');

            try {
                const zip = new JSZip();
                const apps = Array.from(queue.values()).map(v => ({ id: v.id, name: v.n, type: v.id.startsWith("Search:") ? "search" : "id" }));
                zip.file("winget_config.json", JSON.stringify(apps, null, 2));

                // Script Híbrido Melhorado
                let lines = [];
                lines.push('<# :');
                lines.push('@echo off');
                lines.push('chcp 65001 >nul');
                lines.push('cd /d "%~dp0"');
                lines.push('title Winget Pro Installer');
                lines.push('net session >nul 2>&1');
                lines.push('if %errorLevel% neq 0 ( powershell -Command "Start-Process -FilePath \'%~f0\' -Verb RunAs" & exit /b )');
                lines.push('powershell -NoProfile -ExecutionPolicy Bypass -Command "& {[ScriptBlock]::Create((Get-Content \'%~f0\' -Raw) -replace \'(?s)^.*?<# :\', \'\').Invoke()}"');
                lines.push('if %errorLevel% neq 0 pause');
                lines.push('exit /b');
                lines.push('#>');
                
                lines.push('try {');
                lines.push('Add-Type -AssemblyName System.Windows.Forms');
                lines.push('Add-Type -AssemblyName System.Drawing');
                lines.push('$JsonPath = Join-Path $PSScriptRoot "winget_config.json"');
                lines.push('if (-not (Test-Path $JsonPath)) { [System.Windows.Forms.MessageBox]::Show("Arquivo winget_config.json nao encontrado!", "Erro"); exit }');
                
                // CORREÇÃO: Força array @() para garantir que o foreach funcione mesmo com 1 item
                lines.push('$JsonData = Get-Content $JsonPath | ConvertFrom-Json');
                lines.push('if ($JsonData -is [System.Array]) { $Apps = $JsonData } else { $Apps = @($JsonData) }');
                
                lines.push('$F = New-Object System.Windows.Forms.Form');
                lines.push('$F.Text = "Instalador Tecnico"; $F.Size = New-Object System.Drawing.Size(600, 500); $F.StartPosition = "CenterScreen"; $F.BackColor = "#0f172a"; $F.ForeColor = "White"');
                lines.push('$L = New-Object System.Windows.Forms.Label; $L.Text = "Instalando..."; $L.Location = New-Object System.Drawing.Point(20,20); $L.AutoSize = $true; $L.Font = New-Object System.Drawing.Font("Segoe UI", 14, [System.Drawing.FontStyle]::Bold); $F.Controls.Add($L)');
                lines.push('$P = New-Object System.Windows.Forms.ProgressBar; $P.Location = New-Object System.Drawing.Point(20,60); $P.Size = New-Object System.Drawing.Size(540,20); $F.Controls.Add($P)');
                lines.push('$T = New-Object System.Windows.Forms.TextBox; $T.Location = New-Object System.Drawing.Point(20,100); $T.Size = New-Object System.Drawing.Size(540,340); $T.Multiline = $true; $T.ScrollBars = "Vertical"; $T.BackColor = "#1e293b"; $T.ForeColor = "#4ade80"; $T.Font = New-Object System.Drawing.Font("Consolas", 9); $F.Controls.Add($T)');
                lines.push('$Ctx = @{ F=$F; T=$T; P=$P; L=$L; A=$Apps }');
                
                lines.push('$F.Add_Shown({');
                lines.push(' $Th = [System.Threading.Thread]::new({ param($Ctx)');
                lines.push('  $f=$Ctx.F; $t=$Ctx.T; $p=$Ctx.P; $l=$Ctx.L; $a=$Ctx.A');
                lines.push('  function W($m) { $f.Invoke([Action[string]]{ param($x) $t.AppendText("[$((Get-Date).ToString(\'HH:mm\'))] $x" + [Environment]::NewLine); $t.ScrollToCaret() }, $m) }');
                lines.push('  W "Iniciando..."');
                lines.push('  $tot = $a.Count; $cur = 0');
                lines.push('  foreach ($app in $a) {');
                lines.push('   $cur++; $pct = [int](($cur / $tot) * 100)');
                lines.push('   $f.Invoke([Action[int]]{ param($v) $p.Value = $v }, $pct)');
                lines.push('   $id = $app.id; $name = $app.name');
                lines.push('   $f.Invoke([Action[string]]{ param($x) $l.Text = "Instalando: $x" }, $name)');
                lines.push('   W "Baixando: $name ($id)..."');
                lines.push('   $wArgs = "install --id $id -e --silent --accept-package-agreements --accept-source-agreements"');
                lines.push('   if ($app.type -eq "search") { $wArgs = "install --name `"$id`" --silent --accept-package-agreements --accept-source-agreements" }');
                lines.push('   if ($id -match "WinRAR") { $wArgs += " --locale pt-BR" }');
                lines.push('   $proc = Start-Process "winget" -ArgumentList $wArgs -NoNewWindow -PassThru -Wait');
                lines.push('   if ($proc.ExitCode -eq 0) { W "SUCESSO." } else { W "ERRO (Cod $($proc.ExitCode))." }');
                lines.push('  }');
                lines.push('  W "--- FINALIZADO ---"');
                lines.push('  [System.Windows.Forms.MessageBox]::Show("Instalacao Concluida!", "Sucesso")');
                lines.push('  $f.Invoke([Action]{ $f.Close() })');
                lines.push(' })');
                lines.push(' $Th.Start($Ctx)');
                lines.push('})');
                lines.push('$F.Tag = $Ctx');
                lines.push('$F.ShowDialog() | Out-Null');
                lines.push('} catch { Write-Host "Erro Fatal: $($_.Exception.Message)"; pause }');

                const batchScript = lines.join('\n');

                // Tentar buscar o EXE original se existir
                try {
                    const exeRes = await fetch('Instalador.exe');
                    if(exeRes.ok) zip.file("Instalador.exe", await exeRes.blob());
                    else zip.file("Instalador.bat", batchScript); // Fallback para BAT se não achar EXE
                } catch(e) {
                    zip.file("Instalador.bat", batchScript); // Fallback garantido
                }

                zip.file("LEIA-ME.txt", "Extraia tudo e execute o arquivo 'Instalador'.");
                const content = await zip.generateAsync({type:"blob"});
                const url = window.URL.createObjectURL(content);
                const a = document.createElement("a"); a.href = url; a.download = "Pacote_Winget_Pro.zip"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } catch(e) { console.error(e); } finally { if(btn) btn.disabled = false; if(loader) loader.classList.add('hidden'); }
        }
    </script>
</body>
</html>
